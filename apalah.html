document.addEventListener("DOMContentLoaded", function () {
    const board = document.querySelector(".main-content");
    const addColumnButton = document.querySelector(".add-column");
    const modalHTML = `
    <!-- Add Column Modal -->
    <div id="addColumnModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Add New Column</div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="columnName">Column Name</label>
                    <input type="text" id="columnName" placeholder="Enter column name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary cancel-btn">Cancel</button>
                <button class="btn btn-primary save-column-btn">Add Column</button>
            </div>
        </div>
    </div>
    
    <!-- Add Task Modal -->
    <div id="addTaskModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Add New Task</div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="taskTitle">Task Title</label>
                    <input type="text" id="taskTitle" placeholder="Enter task title">
                </div>
                <div class="form-group">
                    <label for="taskDescription">Description</label>
                    <textarea id="taskDescription" placeholder="Enter task description"></textarea>
                </div>
                <div class="form-group">
                    <label for="taskPriority">Priority</label>
                    <select id="taskPriority" class="priority-select">
                        <option style="color:gray;" value="low-priority">Low</option>
                        <option style="color:gray;" value="medium-priority" selected>Medium</option>
                        <option style="color:gray;" value="high-priority">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Labels</label>
                    <div class="label-checkboxes">
                        <div class="label-checkbox">
                            <input type="checkbox" id="labelBug" value="label-bug">
                            <label for="labelBug">Bug</label>
                        </div>
                        <div class="label-checkbox">
                            <input type="checkbox" id="labelFeature" value="label-feature">
                            <label for="labelFeature">Feature</label>
                        </div>
                        <div class="label-checkbox">
                            <input type="checkbox" id="labelDesign" value="label-design">
                            <label for="labelDesign">Design</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="taskAssignee">Assignee Initials</label>
                    <input type="text" id="taskAssignee" placeholder="e.g. JD">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary cancel-btn">Cancel</button>
                <button class="btn btn-primary save-task-btn">Add Task</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Task Modal -->
    <div id="editTaskModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Edit Task</div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editTaskTitle">Task Title</label>
                    <input type="text" id="editTaskTitle" placeholder="Enter task title">
                </div>
                <div class="form-group">
                    <label for="editTaskDescription">Description</label>
                    <textarea id="editTaskDescription" placeholder="Enter task description"></textarea>
                </div>
                <div class="form-group">
                    <label for="editTaskPriority">Priority</label>
                    <select id="editTaskPriority" class="priority-select">
                        <option style="color:gray;" value="low-priority">Low</option>
                        <option style="color:gray;" value="medium-priority">Medium</option>
                        <option style="color:gray;" value="high-priority">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Labels</label>
                    <div class="label-checkboxes">
                        <div class="label-checkbox">
                            <input type="checkbox" id="editLabelBug" value="label-bug">
                            <label for="editLabelBug">Bug</label>
                        </div>
                        <div class="label-checkbox">
                            <input type="checkbox" id="editLabelFeature" value="label-feature">
                            <label for="editLabelFeature">Feature</label>
                        </div>
                        <div class="label-checkbox">
                            <input type="checkbox" id="editLabelDesign" value="label-design">
                            <label for="editLabelDesign">Design</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editTaskAssignee">Assignee Initials</label>
                    <input type="text" id="editTaskAssignee" placeholder="e.g. JD">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger delete-task-btn">Delete</button>
                <button class="btn btn-secondary cancel-btn">Cancel</button>
                <button class="btn btn-primary update-task-btn">Update Task</button>
            </div>
        </div>
    </div>
    
    <!-- Task Actions Modal -->
    <div id="taskActionsModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Task Actions</div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <h3 id="actionTaskTitle" style="margin-bottom: 15px;"></h3>
                <div class="task-actions">
                    <button class="btn btn-secondary edit-btn">Edit Task</button>
                    <button class="btn btn-danger delete-btn">Delete Task</button>
                </div>
            </div>
        </div>
    </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    const addColumnModal = document.getElementById("addColumnModal");
    const addTaskModal = document.getElementById("addTaskModal");
    const editTaskModal = document.getElementById("editTaskModal");
    const taskActionsModal = document.getElementById("taskActionsModal");
    let currentTaskColumn;
    let currentTaskCard;
    
    addColumnButton.addEventListener("click", function() {
        openModal(addColumnModal);
    });
    
    document.querySelectorAll(".add-task-btn").forEach(button => {
        button.addEventListener("click", function() {
            currentTaskColumn = button.closest(".board-column");
            openModal(addTaskModal);
        });
    });
    
    document.querySelectorAll(".modal-close").forEach(closeButton => {
        closeButton.addEventListener("click", function() {
            closeModal(closeButton.closest(".modal-overlay"));
        });
    });
    
    document.querySelectorAll(".cancel-btn").forEach(cancelButton => {
        cancelButton.addEventListener("click", function() {
            closeModal(cancelButton.closest(".modal-overlay"));
        });
    });
    
    document.querySelectorAll(".modal-overlay").forEach(overlay => {
        overlay.addEventListener("click", function(e) {
            if (e.target === overlay) {
                closeModal(overlay);
            }
        });
    });
    
    document.querySelector(".save-column-btn").addEventListener("click", function() {
        const columnNameInput = document.getElementById("columnName");
        const columnName = columnNameInput.value.trim();
        
        if (!columnName) {
            alert("Please enter a column name");
            return;
        }
        
        const newColumn = document.createElement("div");
        newColumn.classList.add("board-column");
        newColumn.innerHTML = `
            <div class="column-header">
                <div class="column-title">
                    <span>${columnName}</span>
                    <span class="task-count">0</span>
                </div>
                <button class="add-task-btn">+</button>
            </div>
            <div class="tasks-container"></div>
        `;
        
        board.insertBefore(newColumn, addColumnButton);
        const newAddTaskBtn = newColumn.querySelector(".add-task-btn");
        newAddTaskBtn.addEventListener("click", function() {
            currentTaskColumn = newColumn;
            openModal(addTaskModal);
        });
        
        closeModal(addColumnModal);
        columnNameInput.value = "";
        
        setupTaskCardListeners();
    });
    
    document.querySelector(".save-task-btn").addEventListener("click", function() {
        const taskTitleInput = document.getElementById("taskTitle");
        const taskDescInput = document.getElementById("taskDescription");
        const taskPrioritySelect = document.getElementById("taskPriority");
        const taskAssigneeInput = document.getElementById("taskAssignee");
        
        const title = taskTitleInput.value.trim();
        const description = taskDescInput.value.trim();
        const priority = taskPrioritySelect.value;
        const assignee = taskAssigneeInput.value.trim() || "N/A";
        
        if (!title) {
            alert("Please enter a task title");
            return;
        }
        
        const selectedLabels = [];
        if (document.getElementById("labelBug").checked) {
            selectedLabels.push('<span class="task-label label-bug">Bug</span>');
        }
        if (document.getElementById("labelFeature").checked) {
            selectedLabels.push('<span class="task-label label-feature">Feature</span>');
        }
        if (document.getElementById("labelDesign").checked) {
            selectedLabels.push('<span class="task-label label-design">Design</span>');
        }
        
        const taskCard = document.createElement("div");
        taskCard.classList.add("task-card", priority);
        
        const labelsHTML = selectedLabels.length > 0 ? 
            `<div class="task-labels">${selectedLabels.join('')}</div>` : '';
        
        taskCard.innerHTML = `
            ${labelsHTML}
            <div class="task-title">${title}</div>
            <div class="task-description">${description || "No description provided"}</div>
            <div class="task-meta">
                <div class="task-members">
                    <div class="member-avatar">${assignee}</div>
                </div>
                <div>${new Date().toLocaleDateString()}</div>
            </div>
        `;
        
        const tasksContainer = currentTaskColumn.querySelector(".tasks-container");
        tasksContainer.appendChild(taskCard);
        updateTaskCount(currentTaskColumn);
        
        taskTitleInput.value = "";
        taskDescInput.value = "";
        taskPrioritySelect.value = "medium-priority";
        taskAssigneeInput.value = "";
        document.getElementById("labelBug").checked = false;
        document.getElementById("labelFeature").checked = false;
        document.getElementById("labelDesign").checked = false;
        
        closeModal(addTaskModal);
        
        setupTaskCardListeners();
    });
    function setupTaskCardListeners() {
        document.querySelectorAll(".task-card").forEach(card => {
            card.setAttribute("draggable", "true");
            
            const newCard = card.cloneNode(true);
            card.parentNode.replaceChild(newCard, card);
            
            newCard.addEventListener("click", function(e) {
                currentTaskCard = this;
                currentTaskColumn = this.closest(".board-column");
                
                const taskTitle = this.querySelector(".task-title").textContent;
                document.getElementById("actionTaskTitle").textContent = taskTitle;
                
                openModal(taskActionsModal);
            });
        });
    }
    
    document.querySelector("#taskActionsModal .edit-btn").addEventListener("click", function() {
        closeModal(taskActionsModal);
        const taskTitle = currentTaskCard.querySelector(".task-title").textContent;
        const taskDesc = currentTaskCard.querySelector(".task-description").textContent;
        let taskPriority = "medium-priority";
        
        if (currentTaskCard.classList.contains("high-priority")) {
            taskPriority = "high-priority";
        } else if (currentTaskCard.classList.contains("low-priority")) {
            taskPriority = "low-priority";
        }
        const assigneeElement = currentTaskCard.querySelector(".member-avatar");
        const assignee = assigneeElement ? assigneeElement.textContent : "";
        document.getElementById("editTaskTitle").value = taskTitle;
        document.getElementById("editTaskDescription").value = taskDesc === "No description provided" ? "" : taskDesc;
        document.getElementById("editTaskPriority").value = taskPriority;
        document.getElementById("editTaskAssignee").value = assignee;
        document.getElementById("editLabelBug").checked = currentTaskCard.innerHTML.includes("label-bug");
        document.getElementById("editLabelFeature").checked = currentTaskCard.innerHTML.includes("label-feature");
        document.getElementById("editLabelDesign").checked = currentTaskCard.innerHTML.includes("label-design");
        openModal(editTaskModal);
    });
    document.querySelector("#taskActionsModal .delete-btn").addEventListener("click", function() {
        if (confirm("Are you sure you want to delete this task?")) {
            currentTaskCard.remove();
            updateTaskCount(currentTaskColumn);
            closeModal(taskActionsModal);
        }
    });

    document.querySelector(".delete-task-btn").addEventListener("click", function() {
        if (confirm("Are you sure you want to delete this task?")) {
            currentTaskCard.remove();
            updateTaskCount(currentTaskColumn);
            closeModal(editTaskModal);
        }
    });
    document.querySelector(".update-task-btn").addEventListener("click", function() {
        const taskTitle = document.getElementById("editTaskTitle").value.trim();
        const taskDesc = document.getElementById("editTaskDescription").value.trim();
        const taskPriority = document.getElementById("editTaskPriority").value;
        const taskAssignee = document.getElementById("editTaskAssignee").value.trim() || "N/A";
        
        if (!taskTitle) {
            alert("Please enter a task title");
            return;
        }
        
        const selectedLabels = [];
        if (document.getElementById("editLabelBug").checked) {
            selectedLabels.push('<span class="task-label label-bug">Bug</span>');
        }
        if (document.getElementById("editLabelFeature").checked) {
            selectedLabels.push('<span class="task-label label-feature">Feature</span>');
        }
        if (document.getElementById("editLabelDesign").checked) {
            selectedLabels.push('<span class="task-label label-design">Design</span>');
        }
    
        currentTaskCard.classList.remove("low-priority", "medium-priority", "high-priority");
        currentTaskCard.classList.add(taskPriority);
        
        const labelsHTML = selectedLabels.length > 0 ? 
            `<div class="task-labels">${selectedLabels.join('')}</div>` : '';
        
        const dateElement = currentTaskCard.querySelector(".task-meta div:last-child");
        const originalDate = dateElement ? dateElement.textContent : new Date().toLocaleDateString();
        
        currentTaskCard.innerHTML = `
            ${labelsHTML}
            <div class="task-title">${taskTitle}</div>
            <div class="task-description">${taskDesc || "No description provided"}</div>
            <div class="task-meta">
                <div class="task-members">
                    <div class="member-avatar">${taskAssignee}</div>
                </div>
                <div>${originalDate}</div>
            </div>
        `;
        
        closeModal(editTaskModal);
        
        setupTaskCardListeners();
    });
    
    function openModal(modal) {
        modal.style.display = "flex";
        const firstInput = modal.querySelector("input");
        if (firstInput) {
            firstInput.focus();
        }
    }
    
    function closeModal(modal) {
        modal.style.display = "none";
    }
    
    function updateTaskCount(column) {
        const taskCount = column.querySelectorAll(".task-card").length;
        column.querySelector(".task-count").textContent = taskCount;
    }
    
    document.addEventListener("keydown", function(e) {
        if (e.key === "Escape") {
            const openModals = document.querySelectorAll(".modal-overlay[style='display: flex;']");
            openModals.forEach(modal => closeModal(modal));
        }
        
        if (e.key === "Enter" && !e.shiftKey && !e.ctrlKey && !e.altKey) {
            const addColumnModalVisible = addColumnModal.style.display === "flex";
            const addTaskModalVisible = addTaskModal.style.display === "flex";
            const editTaskModalVisible = editTaskModal.style.display === "flex";
            
            if (addColumnModalVisible && document.activeElement.id === "columnName") {
                document.querySelector(".save-column-btn").click();
            } else if (addTaskModalVisible && document.activeElement.id === "taskTitle") {
                document.querySelector(".save-task-btn").click();
            } else if (editTaskModalVisible && document.activeElement.id === "editTaskTitle") {
                document.querySelector(".update-task-btn").click();
            }
        }
    });

    function enableDragAndDrop() {
        let draggedItem = null;
        
        document.addEventListener("dragstart", function(e) {
            if (e.target.classList.contains("task-card")) {
                draggedItem = e.target;
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData("text/html", draggedItem.outerHTML);
                e.target.style.opacity = "0.5";
            }
        });
        
        document.addEventListener("dragend", function(e) {
            if (e.target.classList.contains("task-card")) {
                e.target.style.opacity = "1";
            }
        });
        
        document.querySelectorAll(".tasks-container").forEach(container => {
            container.addEventListener("dragover", function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = "move";
            });
            
            container.addEventListener("drop", function(e) {
                e.preventDefault();
                if (draggedItem) {
                    this.appendChild(draggedItem);
                    document.querySelectorAll(".board-column").forEach(updateTaskCount);
                    setupTaskCardListeners();
                }
            });
        });
    }
    
    setupTaskCardListeners();
    enableDragAndDrop();
});